#!/usr/bin/env bash

set -euo pipefail
# Based on the pre-push sample generated by default in .git/hooks
# Source: https://www.git-scm.com/docs/githooks/1.7.1
#
# Prevents push of commits where the log message starts with "WIP" (work in progress).
# Called by "git push" after it has checked the remote status, but before anything has been pushed.


z40=0000000000000000000000000000000000000000

while read -r local_ref local_sha _remote_ref remote_sha; do
  if [[ "${local_sha}" = "${z40}" ]]; then
    # Handle delete
    :
  else
    if [[ "${remote_sha}" = "${z40}" ]]; then
      # New branch, examine all commits
      range="${local_sha}"
    else
      # Update to existing branch, examine new commits
      range="${remote_sha}..${local_sha}"
    fi

    # Check for WIP commit
    commit=$(git rev-list -n 1 --grep '^WIP' "${range}")
    if [[ -n "${commit}" ]]; then
      echo >&2 "Found WIP commit in ${local_ref}, not pushing"
      exit 1
    fi
  fi
done

exit 0
